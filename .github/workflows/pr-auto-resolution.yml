name: Automated PR Resolution and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Run every 6 hours to check open PRs
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Specific PR number to process (optional)'
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read
  statuses: read

jobs:
  audit-and-fix-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub requests pyyaml pylint pytest ruff black isort mypy
          # Install additional dependencies from requirements if they exist
          if [ -f scripts/requirements.txt ]; then
            pip install -r scripts/requirements.txt
          fi

      - name: Install Terraform (for validation)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Run PR Audit and Auto-Fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        run: |
          python scripts/pr_auto_resolver.py

      - name: Post summary comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('pr_resolution_summary.json')) {
              const summary = JSON.parse(fs.readFileSync('pr_resolution_summary.json', 'utf8'));
              const commentBody = `## Automated PR Resolution Summary\n\n${summary.message}\n\n**Status:** ${summary.status}\n**Issues Found:** ${summary.issues_found}\n**Issues Fixed:** ${summary.issues_fixed}\n\n${summary.details || ''}`;
              
              if (context.payload.pull_request) {
                github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: commentBody
                });
              }
            }
