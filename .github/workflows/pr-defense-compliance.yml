name: PR Defense Compliance

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Run bandit security scanner
        run: |
          echo "Running bandit security scanner..."
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || echo "âš ï¸ Security issues found by bandit"
        continue-on-error: true

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          echo "Scanning dependencies for vulnerabilities..."
          pip-audit || echo "âš ï¸ Vulnerable dependencies found"
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for exposed secrets
        run: |
          echo "Scanning for exposed secrets..."
          git grep -i -E '(password|secret|api_key|token|private_key).*=.*["'\''][^"'\'']+["'\'']' || echo "No obvious secrets found"
          
          echo "Checking for hardcoded credentials..."
          git grep -i -E '(aws_access_key|aws_secret_key|github_token|slack_token)' || echo "No hardcoded credentials found"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
        continue-on-error: true

  permissions-check:
    name: Permissions and Privilege Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for elevated permissions
        run: |
          echo "Checking for elevated permissions in workflows..."
          if grep -r "write-all\|actions: write" .github/workflows/; then
            echo "âš ï¸ Found elevated permissions - requires review"
          else
            echo "âœ“ No elevated permissions found"
          fi
        continue-on-error: true

      - name: Check for unsafe script execution
        run: |
          echo "Checking for unsafe script patterns..."
          # Get the base branch ref, handling cases where it might not exist
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          if [ -n "$BASE_REF" ] && git cat-file -e "$BASE_REF" 2>/dev/null; then
            git diff "$BASE_REF"...HEAD -- '*.sh' '*.py' | grep -E '(eval|exec|os\.system)' || echo "âœ“ No unsafe patterns found in changed files"
          else
            echo "â„¹ï¸ Base ref not available, checking all files..."
            git grep -E '(eval|exec|os\.system)' -- '*.sh' '*.py' && echo "âš ï¸ Found potentially unsafe patterns" || echo "âœ“ No unsafe patterns found"
          fi
        continue-on-error: true

  dockerfile-security:
    name: Dockerfile Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dockerfiles
        run: |
          echo "Scanning Dockerfiles for security issues..."
          FOUND_DOCKERFILES=false
          find . -name "Dockerfile*" -type f | while read -r dockerfile; do
            FOUND_DOCKERFILES=true
            echo "Checking $dockerfile"
            
            # Check for root user
            if grep -q "USER root" "$dockerfile" 2>/dev/null; then
              echo "âš ï¸ $dockerfile uses root user"
            fi
            
            # Check for latest tags
            if grep -q ":latest" "$dockerfile" 2>/dev/null; then
              echo "âš ï¸ $dockerfile uses :latest tag"
            fi
            
            # Check for COPY with broad patterns
            if grep -qE "COPY \. \." "$dockerfile" 2>/dev/null; then
              echo "âš ï¸ $dockerfile uses broad COPY pattern"
            fi
          done
          
          # Check if we found any Dockerfiles
          if ! find . -name "Dockerfile*" -type f | grep -q .; then
            echo "â„¹ï¸ No Dockerfiles found"
          fi

  defense-summary:
    name: Defense Compliance Summary
    runs-on: ubuntu-latest
    needs: [security-scan, secret-scanning, dependency-review, permissions-check, dockerfile-security]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## PR Defense Compliance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ›¡ï¸ All security and defense checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checks Run:" >> $GITHUB_STEP_SUMMARY
          echo "- Security vulnerability scanning (bandit, pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- Secret and credential detection" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency security review" >> $GITHUB_STEP_SUMMARY
          echo "- Permissions and privilege escalation checks" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile security scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed results, check individual job outputs above." >> $GITHUB_STEP_SUMMARY
